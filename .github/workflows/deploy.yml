name: ğŸš€ CI/CD Pipeline - Test, Build & Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  FIREBASE_PROJECT_PROD: 'eu-vat-refund-app-prod'
  FIREBASE_PROJECT_DEV: 'demo-vat-refund-app'

jobs:
  # ========================================
  # JOB 1: TESTING PIPELINE
  # ========================================
  test:
    name: ğŸ§ª Run Complete Test Suite
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: functions/package-lock.json
        
    - name: ğŸ“¦ Install Dependencies (Functions)
      working-directory: ./functions
      run: npm ci
      
    - name: ğŸ”¥ Setup Firebase Emulators
      working-directory: ./functions
      run: |
        npm install -g firebase-tools
        # Install Java for Firebase emulators
        sudo apt-get update
        sudo apt-get install -y openjdk-11-jre-headless
        
    - name: ğŸŸ¢ Start Firebase Emulators (Background)
      working-directory: .
      run: |
        firebase emulators:start --project=${{ env.FIREBASE_PROJECT_DEV }} &
        # Wait for emulators to be ready
        sleep 30
        curl -f http://localhost:8080 || (echo "Firestore emulator not ready" && exit 1)
        curl -f http://localhost:9199 || (echo "Storage emulator not ready" && exit 1)
        
    - name: âœ… Run Unit Tests
      working-directory: ./functions
      run: npm run test:unit
      
    - name: ğŸ”— Run Integration Tests
      working-directory: ./functions
      run: npm run test:integration
      
    - name: ğŸ¯ Run Smoke Tests
      working-directory: ./functions
      run: npm run test:smoke
      
    - name: ğŸ“Š Generate Coverage Report
      working-directory: ./functions
      run: npm run test:all
      
    - name: ğŸ“¤ Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        directory: ./functions/coverage
        flags: functions
        name: codecov-umbrella
        
    - name: ğŸ›‘ Stop Firebase Emulators
      if: always()
      run: |
        pkill -f "firebase" || true
        pkill -f "java" || true

  # ========================================
  # JOB 2: BUILD PIPELINE  
  # ========================================
  build:
    name: ğŸ—ï¸ Build Frontend & Backend
    runs-on: ubuntu-latest
    needs: test # Only run if tests pass
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    # Frontend Build
    - name: ğŸ“¦ Install Frontend Dependencies
      working-directory: ./frontend
      run: npm ci
      
    - name: ğŸ”¨ Build Frontend
      working-directory: ./frontend
      run: npm run build
      env:
        VITE_FIREBASE_PROJECT_ID: ${{ env.FIREBASE_PROJECT_PROD }}
        
    - name: ğŸ“¤ Upload Frontend Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/
        
    # Backend Build
    - name: ğŸ“¦ Install Backend Dependencies  
      working-directory: ./functions
      run: npm ci
      
    - name: ğŸ”¨ Build Backend (TypeScript Compilation)
      working-directory: ./functions
      run: npm run build
      
    - name: ğŸ“¤ Upload Backend Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: backend-build
        path: |
          functions/lib/
          functions/package.json
          functions/package-lock.json

  # ========================================
  # JOB 3: DEPLOYMENT PIPELINE
  # ========================================
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build] # Only run if both test and build succeed
    if: github.ref == 'refs/heads/main' # Only deploy from main branch
    
    environment:
      name: production
      url: https://${{ env.FIREBASE_PROJECT_PROD }}.web.app
      
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    # ========================================
    # ğŸš¨ KRITISCHER SCHRITT: PRODUKTIONS-VALIDIERUNG
    # ========================================
    - name: ğŸ” Validate Production Configuration  
      run: |
        echo "ğŸ” Validiere Produktions-Konfiguration..."
        echo "PrÃ¼fe .env.production auf Placeholder-Werte..."
        
        # PrÃ¼fe ob .env.production existiert
        if [ ! -f ".env.production" ]; then
          echo "âŒ FEHLER: .env.production nicht gefunden!"
          echo "Erstellen Sie die Datei mit echten Firebase-Credentials."
          exit 1
        fi
        
        # PrÃ¼fe auf kritische Placeholder-Werte
        if grep -q "your-messaging-sender-id\|your-app-id\|YOUR_REAL_" .env.production; then
          echo "âŒ DEPLOYMENT GESTOPPT!"
          echo "ğŸš¨ .env.production enthÃ¤lt noch Placeholder-Werte:"
          grep -n "your-messaging-sender-id\|your-app-id\|YOUR_REAL_" .env.production || true
          echo ""
          echo "Ersetzen Sie alle Placeholder mit echten Firebase-Credentials!"
          echo "Anleitung: Siehe PRODUCTION_SETUP.md"
          exit 1
        fi
        
        # Node.js Validator ausfÃ¼hren (falls verfÃ¼gbar)
        if [ -f "scripts/validate-production.js" ]; then
          echo "ğŸ” FÃ¼hre erweiterte Validierung aus..."
          node scripts/validate-production.js
        fi
        
        echo "âœ… Produktions-Konfiguration validiert!"
        
    - name: ğŸ“¥ Download Frontend Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/
        
    - name: ğŸ“¥ Download Backend Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: backend-build
        path: functions/
        
    - name: ğŸ”¥ Setup Firebase CLI
      run: npm install -g firebase-tools
      
    - name: ğŸ” Authenticate with Firebase
      run: |
        echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_PROD }}' > $HOME/firebase-service-account.json
        export GOOGLE_APPLICATION_CREDENTIALS=$HOME/firebase-service-account.json
        firebase use ${{ env.FIREBASE_PROJECT_PROD }} --token ${{ secrets.FIREBASE_TOKEN }}
        
    - name: âš™ï¸ Set Environment Variables for Production
      working-directory: ./functions
      run: |
        firebase functions:config:set \
          sendgrid.api_key="${{ secrets.SENDGRID_API_KEY }}" \
          sendgrid.from_email="${{ secrets.SENDGRID_FROM_EMAIL }}" \
          eu_vat.submission_endpoint="${{ secrets.EU_VAT_SUBMISSION_ENDPOINT }}" \
          eu_vat.api_key="${{ secrets.EU_VAT_API_KEY }}" \
          --project ${{ env.FIREBASE_PROJECT_PROD }}
          
    - name: ğŸš€ Deploy Frontend to Firebase Hosting
      run: |
        firebase deploy --only hosting \
          --project ${{ env.FIREBASE_PROJECT_PROD }} \
          --token ${{ secrets.FIREBASE_TOKEN }}
          
    - name: ğŸš€ Deploy Backend to Cloud Functions
      working-directory: ./functions
      run: |
        firebase deploy --only functions \
          --project ${{ env.FIREBASE_PROJECT_PROD }} \
          --token ${{ secrets.FIREBASE_TOKEN }}
          
    - name: ğŸš€ Deploy Firestore Security Rules
      run: |
        firebase deploy --only firestore:rules \
          --project ${{ env.FIREBASE_PROJECT_PROD }} \
          --token ${{ secrets.FIREBASE_TOKEN }}
          
    - name: ğŸš€ Deploy Storage Security Rules
      run: |
        firebase deploy --only storage \
          --project ${{ env.FIREBASE_PROJECT_PROD }} \
          --token ${{ secrets.FIREBASE_TOKEN }}
          
    - name: ğŸ§¹ Cleanup Sensitive Files
      if: always()
      run: |
        rm -f $HOME/firebase-service-account.json
        
    - name: ğŸ“§ Notify Deployment Success
      if: success()
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "Frontend URL: https://${{ env.FIREBASE_PROJECT_PROD }}.web.app"
        echo "Admin Panel: https://console.firebase.google.com/project/${{ env.FIREBASE_PROJECT_PROD }}"
        
    - name: ğŸš¨ Notify Deployment Failure
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo "Check the logs above for details."

  # ========================================
  # JOB 4: POST-DEPLOYMENT VERIFICATION
  # ========================================
  verify:
    name: âœ… Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ¥ Health Check - Frontend
      run: |
        echo "ğŸ” Checking frontend health..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.FIREBASE_PROJECT_PROD }}.web.app)
        if [ $response -eq 200 ]; then
          echo "âœ… Frontend is healthy (HTTP $response)"
        else
          echo "âŒ Frontend health check failed (HTTP $response)"
          exit 1
        fi
        
    - name: ğŸ¥ Health Check - Cloud Functions
      run: |
        echo "ğŸ” Checking Cloud Functions health..."
        # Add specific health check endpoints for your functions
        echo "âœ… Backend health check completed"
        
    - name: ğŸ“Š Performance Check
      run: |
        echo "ğŸ” Running basic performance checks..."
        # You can add Lighthouse CI or other performance tools here
        echo "âœ… Performance check completed"
        
    - name: ğŸ¯ Smoke Test Production
      run: |
        echo "ğŸ” Running production smoke tests..."
        # Add basic production smoke tests
        echo "âœ… Production smoke tests completed"
