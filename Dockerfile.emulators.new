# Firebase Emulators Dockerfile - Optimiert f체r Stabilit채t
FROM node:20-alpine

# Install Java f체r Firestore emulator (neueste LTS Version)
RUN apk add --no-cache openjdk17-jre curl

# Install Firebase CLI global
RUN npm install -g firebase-tools@latest

WORKDIR /app

# Copy Firebase Konfigurationsdateien
COPY firebase.json .
COPY firestore.rules .
COPY firestore.indexes.json .
COPY storage.rules .
COPY .firebaserc .

# Copy Functions source
COPY functions ./functions

# Install Functions dependencies
WORKDIR /app/functions
RUN npm ci

# Back to app root
WORKDIR /app

# Create emulator data directory
RUN mkdir -p /app/emulator-data

# Expose all emulator ports
EXPOSE 4300 8080 9099 5001 9199

# Health check for emulators
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=5 \
  CMD curl -f http://localhost:4300/ || exit 1

# Start emulators mit Export/Import f체r Datenpersistierung
CMD ["firebase", "emulators:start", \
     "--project", "demo-vat-refund-app", \
     "--export-on-exit", "/app/emulator-data", \
     "--import", "/app/emulator-data"]
